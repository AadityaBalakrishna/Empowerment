package com.safepage.security;

import com.empower.epw.aws.api.kms.EpwKmsService;
import com.empower.epw.aws.api.kms.dto.DecryptRequestDTO;
import com.empower.epw.aws.api.kms.dto.DecryptResponseDTO;
import com.empower.epw.aws.api.kms.dto.EncryptRequestDTO;
import com.empower.epw.aws.api.kms.dto.EncryptResponseDTO;
import com.safepage.exception.SafePageException;
import com.safepage.json.JSONObject;
import com.safepage.security.CryptEngine.CreatePrimaryKeySeed;
import com.safepage.security.KeyManager.KeyData;
import com.safepage.security.data.KeySeed;
import com.safepage.security.data.KeySeedType;
import com.safepage.security.data.impl.KeySeedImpl;
import com.safepage.user.data.AuthUser;
import com.safepage.user.data.User;
import org.joda.time.DateTime;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;

import java.security.Key;

import static com.safepage.security.CryptType.MODE;
import static java.lang.Boolean.FALSE;
import static java.lang.Boolean.TRUE;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

import static org.mockito.MockitoAnnotations.openMocks;
import static org.springframework.test.util.ReflectionTestUtils.setField;

public class CryptEngineMockTest
{
	static
	{
		System.setProperty("SKIP_CRYPT_POOL", "TRUE");
	}

	@Mock
	private KeyManager keyManager;

	@Mock
	private EpwKmsService epwKmsService;

	@InjectMocks
	private CryptEngine cryptEngine;

	private static KeyManager keyManagerForMockSeedData;

	private static String rawSystemSecondaryKeySeed;
	private static String rawUserKeySeed;

	private static Key systemSecondaryKeyV2;
	private static Key systemSecondaryKeyV4;
	private static Key userKeyV3;
	private static Key userKeyV5;

	private AuthUser existingUser = null;

	private String EXISTING_USERNAME = "existing_test@pcap.com";

	/**
	 * Generate these key seeds and keys once because random number generation can be
	 * time-consuming.
	 */
	@BeforeAll
	public static void oneTimeSetup()
	{
		keyManagerForMockSeedData = new KeyManager();

		try
		{
			rawSystemSecondaryKeySeed = keyManagerForMockSeedData.generateNewSeedValue();
			rawUserKeySeed = keyManagerForMockSeedData.generateNewSeedValue();

			systemSecondaryKeyV2 = keyManagerForMockSeedData.createKeyFromSeed(
					rawSystemSecondaryKeySeed, KeyManager.DEFAULT_KEY_SIZE, null);
			systemSecondaryKeyV4 = keyManagerForMockSeedData.createKeyFromSeed(
					rawSystemSecondaryKeySeed, KeyManager.DEFAULT_KEY_SIZE,
					KeyManager.DEFAULT_KEY_MATERIAL_HASH);

			userKeyV3 = keyManagerForMockSeedData.createKeyFromSeed(rawUserKeySeed,
					KeyManager.DEFAULT_KEY_SIZE, null);
			userKeyV5 = keyManagerForMockSeedData.createKeyFromSeed(rawUserKeySeed,
					KeyManager.DEFAULT_KEY_SIZE, KeyManager.DEFAULT_KEY_MATERIAL_HASH);
		}
		catch (Exception e)
		{
			fail("oneTimeSetup failed with: " + e);
		}
	}

	@BeforeEach
	public void init() throws Exception
	{
		openMocks(this);
		setField(cryptEngine, "keyManager", keyManager);
		setField(cryptEngine, "epwKmsService", epwKmsService);
		setField(cryptEngine, "minIdleSeedPoolSize", 1);
		setField(cryptEngine, "maxIdleUserSeedPoolSize", 2);
		setField(cryptEngine, "maxUserSeedPoolSize", 5);
		setField(cryptEngine, "timeBetweenEvictionRunsInSeconds", 5);

		when(keyManager.isSystmePrimaryKeyMigratedToAWS()).thenReturn(FALSE);

		EncryptResponseDTO mockEncryptResponse = new EncryptResponseDTO();
		mockEncryptResponse.setCiphertext("dummyEncryptedSeed");
		when(epwKmsService.encrypt(any(EncryptRequestDTO.class))).thenReturn(mockEncryptResponse);

		DecryptResponseDTO mockDecryptResponse = new DecryptResponseDTO();
		mockDecryptResponse.setPlaintext(rawSystemSecondaryKeySeed);
		when(epwKmsService.decrypt(any(DecryptRequestDTO.class))).thenReturn(mockDecryptResponse);
	}

	private AuthUser initializeUser(String email, long id) throws Exception
	{
		AuthUser existingUser = Mockito.mock(AuthUser.class);
		when(existingUser.getUsername()).thenReturn(EXISTING_USERNAME + id + "@pc.com");
		when(existingUser.getId()).thenReturn(id);
		when(existingUser.getUser()).thenReturn(Mockito.mock(User.class));
		when(existingUser.isPersonDelegate()).thenReturn(false);
		return existingUser;
	}

	/*
	 * PLAT-4119: Allow user to set the "encryptedKeySeed" and "encryptionVersion" for the default
	 * System Secondary Key.
	 */
	private void setUpSystemSecondaryKey(String systemSecondaryKeySeed, String encryptionVersion)
	{
		try
		{
			doReturn(true).when(keyManager)
					.isSystmePrimaryKeyMigratedToAWS();
			doReturn("alias/app/pcap/pcap/system_primary/v1").when(keyManager)
					.getSystemPrimaryAliasName();

			String encryptedSystemSecondaryKeySeed = cryptEngine
					.encryptUsingSystemPrimaryKey(systemSecondaryKeySeed);

			KeySeed keySeed = createKeySeed(encryptionVersion, encryptedSystemSecondaryKeySeed);

			// Set up Key Data for System Secondary Key generated with V2 logic
			KeyData systemSecondaryKeyDataV2 = new KeyManager.KeyData(systemSecondaryKeyV2,
					keySeed);
			doReturn(systemSecondaryKeyDataV2).when(keyManager)
					.getSystemSecondaryKeyByName("AA", null);

			// Set up Key Data for System Secondary Key generated with V4 logic
			KeyData systemSecondaryKeyDataV4 = new KeyManager.KeyData(systemSecondaryKeyV4,
					keySeed);
			doReturn(systemSecondaryKeyDataV4).when(keyManager)
					.getSystemSecondaryKeyByName("AA", KeyManager.DEFAULT_KEY_MATERIAL_HASH);

			// Default SSK depends on if `encryptionVersion` is set
			if (CryptType.V4.equals(encryptionVersion))
			{
				doReturn(systemSecondaryKeyDataV4).when(keyManager)
						.getDefaultSystemSecondaryKey();
			}
			else
			{
				doReturn(systemSecondaryKeyDataV2).when(keyManager)
						.getDefaultSystemSecondaryKey();
			}
		}
		catch (Exception e)
		{
			fail("setUpSystemSecondaryKey Failed: " + e);
		}
	}

	private KeySeed createKeySeed(String encryptionVersion, String encryptedValue)
	{
		KeySeed keySeed = new KeySeedImpl();
		keySeed.setId(100l);
		keySeed.setDefaultKey(TRUE);
		keySeed.setName("AA");
		keySeed.setValue(encryptedValue);
		keySeed.setValidUntil(new DateTime().plusDays(100)
				.toDate());
		keySeed.setEncryptionVersion(encryptionVersion);
		return keySeed;
	}

	/**
	 * Test encryptung and decrypting new seed with AWS key - system primary key
	 * 
	 * @throws Exception
	 */
	@Test
	public void testEncryptDecryptUsingSystemPrimaryKey_AWS() throws Exception
	{
		when(keyManager.isSystmePrimaryKeyMigratedToAWS()).thenReturn(true);
		when(keyManager.getSystemPrimaryAliasName())
				.thenReturn("alias/app/pcap/pcap/system_primary/v1");
		String plainSeedValue = rawSystemSecondaryKeySeed;
		String encryptedSeedValue = CryptType.SYSTEM_PRIMARY.getVersion() + "_encrypted_dummy";
		stubAwsKmsEncryption(plainSeedValue, encryptedSeedValue);
		// Encrypt using system primary key
		String encryptedSystemSecondaryKeySeed = cryptEngine
				.encryptUsingSystemPrimaryKey(plainSeedValue);
		assertNotNull(encryptedSystemSecondaryKeySeed);
		assertTrue(
				encryptedSystemSecondaryKeySeed.startsWith(CryptType.SYSTEM_PRIMARY.getVersion()));

		// Decrypt using system primary key
		String decryptedSystemSecondaryKeySeed = cryptEngine
				.decryptUsingSystemPrimaryKey(encryptedSystemSecondaryKeySeed);
		assertNotNull(decryptedSystemSecondaryKeySeed);
		assertEquals(decryptedSystemSecondaryKeySeed, plainSeedValue);
	}

	@Test
	public void testEncryptDecryptUsingSystemPrimaryKey_AWS_2() throws Exception
	{
		when(keyManager.isSystmePrimaryKeyMigratedToAWS()).thenReturn(true);
		when(keyManager.getSystemPrimaryAliasName())
				.thenReturn("alias/app/pcap/pcap/system_primary/v1");
		String plainSeedValue = rawSystemSecondaryKeySeed;
		// Encrypt using system primary key
		String encryptedSystemSecondaryKeySeed = cryptEngine.encrypt(CryptType.SYSTEM_PRIMARY,
				plainSeedValue);
		assertNotNull(encryptedSystemSecondaryKeySeed);

		// Decrypt using system primary key
		String decryptedSystemSecondaryKeySeed = cryptEngine.decrypt(CryptType.SYSTEM_PRIMARY,
				encryptedSystemSecondaryKeySeed);
		assertEquals(decryptedSystemSecondaryKeySeed, plainSeedValue);
	}

	private void stubAwsKmsEncryption(String plaintext, String ciphertext) throws SafePageException {
		EncryptResponseDTO encryptResponse = new EncryptResponseDTO();
		encryptResponse.setCiphertext(ciphertext);
		when(epwKmsService.encrypt(any(EncryptRequestDTO.class))).thenReturn(encryptResponse);

		DecryptResponseDTO decryptResponse = new DecryptResponseDTO();
		decryptResponse.setPlaintext(plaintext);
		when(epwKmsService.decrypt(any(DecryptRequestDTO.class))).thenReturn(decryptResponse);
	}
}


please refactor the usage of DTOs in this
