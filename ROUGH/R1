package com.empower.epw.crm.gateway.controller;

import io.awspring.cloud.sqs.operations.SqsTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/sqs-debug")
// Optional: Use @Profile("!prod") to ensure this never deploys to production
public class SqsDebugController {

    private final SqsTemplate sqsTemplate;

    // Inject your queue URL from application.properties if you want a default
    // value="${your.queue.property.name}"
    private String defaultQueueUrl = "https://sqs.us-west-2.amazonaws.com/179355710817/DEVTRUNK_CRM_GATEWAY_DRY_RUN";

    public SqsDebugController(SqsTemplate sqsTemplate) {
        this.sqsTemplate = sqsTemplate;
    }

    @PostMapping("/send")
    public ResponseEntity<String> sendMessage(
            @RequestBody String messagePayload,
            @RequestParam(required = false) String queueUrl) {

        String targetQueue = (queueUrl != null && !queueUrl.isEmpty()) ? queueUrl : defaultQueueUrl;

        try {
            sqsTemplate.send(to -> to
                    .queue(targetQueue)
                    .payload(messagePayload)
            );
            return ResponseEntity.ok("Successfully sent message to: " + targetQueue);
        } catch (Exception e) {
             return ResponseEntity.internalServerError().body("Failed to send message: " + e.getMessage());
        }
    }
}
