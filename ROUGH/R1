package com.empower.epw.crm.gateway.sqs;

import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value; // <-- Import @Value
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

/**
 * This test validates the application's REAL producer service
 * by connecting to the REAL AWS environment.
 *
 * It uses the 'e2e' profile and injects the queue names
 * from the Spring environment (Config Store).
 */
@SpringBootTest
@ActiveProfiles("e2e")
class AwsLiveIntegrationProducerTest {

    private static final Logger log = LoggerFactory.getLogger(AwsLiveIntegrationProducerTest.class);

    @Autowired
    private CrmMessageProducerService producerService;

    // --- THE CHANGE ---
    // Inject the queue names from the config store, just like the app
    @Value("${crm.gateway.sqs.queue.dryrun}")
    private String dryRunQueue;

    @Value("${crm.gateway.sqs.queue.intermediate}")
    private String intermediateQueue;

    @Value("${crm.gateway.sqs.queue.normal}")
    private String normalQueue;

    @Value("${crm.gateway.sqs.queue.top}")
    private String topQueue;

    @Test
    void sendMessagesToLiveAwsQueues() {
        String successPayload = "{\"event\":\"LIVE_CONFIG_STORE_TEST\"}";
        String failurePayload = "FAIL_MESSAGE";

        log.info("--- Sending messages to REAL AWS SQS queues using injected config ---");

        // 1. Send success messages (using the injected queue names)
        log.info("Sending 'success' message to DRY_RUN...");
        producerService.sendMessage(dryRunQueue, successPayload);

        log.info("Sending 'success' message to INTERMEDIATE...");
        producerService.sendMessage(intermediateQueue, successPayload);
        
        log.info("Sending 'success' message to NORMAL...");
        producerService.sendMessage(normalQueue, successPayload);

        log.info("Sending 'success' message to TOP...");
        producerService.sendMessage(topQueue, successPayload);

        // 2. Send failure message
        log.info("Sending 'failure' (FAIL_MESSAGE) message to DRY_RUN...");
        producerService.sendMessage(dryRunQueue, failurePayload);

        log.info("--- All messages sent to AWS. ---");
        log.info("--- GO CHECK YOUR 'MR CONTAINER' LOGS NOW! ---");
    }
}
