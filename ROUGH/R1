package com.empower.epw.crm.gateway.sqs;

import io.awspring.cloud.sqs.operations.SqsTemplate;
import io.awspring.cloud.sqs.config.SqsBootstrapConfiguration;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.ImportAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.testcontainers.containers.localstack.LocalStackContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import static org.assertj.core.api.Assertions.assertThat;

import com.amazonaws.services.sqs.AmazonSQS;
import com.amazonaws.services.sqs.model.CreateQueueRequest;
import org.testcontainers.utility.DockerImageName;

@SpringBootTest
@Testcontainers
@Import({ CrmGatewayMessageListener.class })
@ImportAutoConfiguration(SqsBootstrapConfiguration.class)
class CrmGatewayMessageListenerIT {

    private static final String DRY_RUN_QUEUE = "DEVTRUNK_CRM_GATEWAY_DRY_RUN";
    private static final String INTERMEDIATE_QUEUE = "DEVTRUNK_CRM_GATEWAY_INTERMEDIATE";
    private static final String NORMAL_QUEUE = "DEV_CRM_GATEWAY_NORMAL";
    private static final String TOP_QUEUE = "DEVTRUNK_CRM_GATEWAY_TOP";

    @Container
    static final LocalStackContainer localstack =
            new LocalStackContainer(DockerImageName.parse("localstack/localstack:3.0"))
                    .withServices(LocalStackContainer.Service.SQS);

    @DynamicPropertySource
    static void registerProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.cloud.aws.sqs.endpoint", () -> localstack.getEndpointOverride(LocalStackContainer.Service.SQS).toString());
        registry.add("spring.cloud.aws.region.static", localstack::getRegion);
        registry.add("spring.cloud.aws.credentials.access-key", localstack::getAccessKey);
        registry.add("spring.cloud.aws.credentials.secret-key", localstack::getSecretKey);

        // crm gateway queue names
        registry.add("crm.gateway.sqs.queue.dryrun", () -> DRY_RUN_QUEUE);
        registry.add("crm.gateway.sqs.queue.intermediate", () -> INTERMEDIATE_QUEUE);
        registry.add("crm.gateway.sqs.queue.normal", () -> NORMAL_QUEUE);
        registry.add("crm.gateway.sqs.queue.top", () -> TOP_QUEUE);
    }

    @Autowired
    private SqsTemplate sqsTemplate;

    @Autowired
    private CrmGatewayMessageListener listener;

    @Autowired
    private AmazonSQS amazonSQS;

    @BeforeEach
    void setupQueues() {
        amazonSQS.createQueue(new CreateQueueRequest(DRY_RUN_QUEUE));
        amazonSQS.createQueue(new CreateQueueRequest(INTERMEDIATE_QUEUE));
        amazonSQS.createQueue(new CreateQueueRequest(NORMAL_QUEUE));
        amazonSQS.createQueue(new CreateQueueRequest(TOP_QUEUE));
    }

    @Test
    void testMessageIsConsumedSuccessfully() throws Exception {
        String payload = "{\"event\":\"CustomerUpdated\",\"id\":123}";
        sqsTemplate.send(DRY_RUN_QUEUE, payload);

        // Give listener some time to consume (async)
        Thread.sleep(2000);

        // Nothing to assert directly (listener logs message)
        // But we can assume test passes if no exceptions
        assertThat(true).isTrue();
    }
}
