package com.empower.epw.crm.gateway.sqs;

import io.awspring.cloud.sqs.annotation.SqsListener;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Recover;
import org.springframework.retry.annotation.Retryable;
import org.springframework.stereotype.Component;
import lombok.CustomLog;

@CustomLog
@Component
@ConditionalOnProperty(name = "crm.gateway.listener.enabled", havingValue = "true", matchIfMissing = false)
public class CrmGatewayMessageListener
{
	private final CrmProcessingService processingService;

	@Autowired
	public CrmGatewayMessageListener(CrmProcessingService processingService)
	{
		this.processingService = processingService;
	}

	@SqsListener("${crm.gateway.sqs.queue.dryrun:}")
	@Retryable(value =
	{
			Exception.class
	}, maxAttemptsExpression = "#{${crm.gateway.sqs.retry.max-attempts:3}}", backoff = @Backoff(delayExpression = "#{${crm.gateway.sqs.retry.backoff-delay:1000}}"))
	public void handleDryRunMessage(String message,
			@Header(name = "id", required = false) String messageId)
	{
		processingService.processMessage("DRY_RUN", message, messageId);
	}

	/*
	 * TEMPORARILY DISABLED FOR DLQ PoC This queue is now acting as DLQ for other queues Hence the
	 * listener for this queue is disabled
	 */
	/*
	 * @SqsListener("${crm.gateway.sqs.queue.intermediate:}")
	 * 
	 * @Retryable(value = { Exception.class }, maxAttemptsExpression =
	 * "#{${crm.gateway.sqs.retry.max-attempts:3}}", backoff = @Backoff(delayExpression =
	 * "#{${crm.gateway.sqs.retry.backoff-delay:1000}}")) public void
	 * handleIntermediateMessage(String message,
	 * 
	 * @Header(name = "id", required = false) String messageId) {
	 * processingService.processMessage("INTERMEDIATE", message, messageId); }
	 */

	@SqsListener("${crm.gateway.sqs.queue.normal:}")
	@Retryable(value =
	{
			Exception.class
	}, maxAttemptsExpression = "#{${crm.gateway.sqs.retry.max-attempts:3}}", backoff = @Backoff(delayExpression = "#{${crm.gateway.sqs.retry.backoff-delay:1000}}"))
	public void handleNormalMessage(String message,
			@Header(name = "id", required = false) String messageId)
	{
		processingService.processMessage("NORMAL", message, messageId);
	}

	@SqsListener("${crm.gateway.sqs.queue.top:}")
	@Retryable(value =
	{
			Exception.class
	}, maxAttemptsExpression = "#{${crm.gateway.sqs.retry.max-attempts:3}}", backoff = @Backoff(delayExpression = "#{${crm.gateway.sqs.retry.backoff-delay:1000}}"))
	public void handleTopMessage(String message,
			@Header(name = "id", required = false) String messageId)
	{
		processingService.processMessage("TOP", message, messageId);
	}

	@Recover
	public void recoverFailedMessages(Exception e, String message, String messageId)
	{
		processingService.recoverFailedMessages(e, message, messageId);
	}
}


this is the current existing listener class
