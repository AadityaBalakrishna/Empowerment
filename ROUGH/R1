package com.personalcapital.salesforce.sps.repository;

import com.personalcapital.salesforce.sps.entity.SpsCirrusContactMetadata;
import com.personalcapital.salesforce.sps.enums.DataSource;
import com.personalcapital.salesforce.sps.enums.RegistrationStatus;
import com.personalcapital.salesforce.sps.enums.UserSpsPlanType;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Slice;
import org.springframework.test.annotation.Rollback;
import org.springframework.test.context.junit.jupiter.SpringJUnitConfig;
import org.springframework.transaction.annotation.Transactional;

import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.UUID;

/**
 * Integration tests for SpsCirrusContactMetadataRepository.
 */
@Rollback
@Transactional(value = "spTran")
@SpringJUnitConfig(locations = "classpath:persistenceApplicationContext.xml")
public class SpsCirrusContactMetadataRepositoryTest {

    @Autowired
    private SpsCirrusContactMetadataRepository repository;

    @PersistenceContext
    private EntityManager entityManager;

    private SpsCirrusContactMetadata entity1;
    private SpsCirrusContactMetadata entity2;

    private final UUID userGuid1 = UUID.randomUUID();
    private final UUID userGuid2 = UUID.randomUUID();
    private final UUID personaId1 = UUID.randomUUID();

    @BeforeEach
    public void setUp() {
        // Setup initial data
        entity1 = new SpsCirrusContactMetadata();
        entity1.setUserAccountGuid(userGuid1);
        entity1.setPersonaId(personaId1);
        entity1.setUserSpsPlanType(UserSpsPlanType.CONFORMING);
        entity1.setRegistrationStatus(RegistrationStatus.PENDING);
        entity1.setDataSource(DataSource.ACCOUNT);
        entity1.setRetryCount(0);
        entity1.setUpdatedDate(new Date());
        repository.save(entity1);

        entity2 = new SpsCirrusContactMetadata();
        entity2.setUserAccountGuid(userGuid2);
        entity2.setPersonaId(UUID.randomUUID());
        entity2.setUserSpsPlanType(UserSpsPlanType.NON_CONFORMING);
        entity2.setRegistrationStatus(RegistrationStatus.COMPLETED);
        entity2.setDataSource(DataSource.C_AND_H);
        entity2.setRetryCount(2);
        entity2.setUpdatedDate(new Date());
        repository.save(entity2);

        // Flush to ensure IDs are generated and data is in DB for native queries
        entityManager.flush();
    }

    @Test
    public void testFindByMetadataId() {
        // The ID is generated on save, so we retrieve it from the saved entity
        UUID id = entity1.getMetadataId();
        Assertions.assertNotNull(id, "Metadata ID should be generated upon save");

        SpsCirrusContactMetadata found = repository.findByMetadataId(id);
        Assertions.assertNotNull(found);
        Assertions.assertEquals(userGuid1, found.getUserAccountGuid());
    }

    @Test
    public void testFindByRegistrationStatusWithPagination() {
        // Create a few more PENDING entities to test pagination
        createExtraEntity(RegistrationStatus.PENDING);
        createExtraEntity(RegistrationStatus.PENDING);
        
        // Request page 0 with size 2
        Slice<SpsCirrusContactMetadata> slice = repository.findByRegistrationStatus(
                RegistrationStatus.PENDING, PageRequest.of(0, 2));

        Assertions.assertNotNull(slice);
        Assertions.assertEquals(2, slice.getNumberOfElements());
        Assertions.assertTrue(slice.hasNext(), "Should have a next page given we added 3 PENDING items");
    }

    @Test
    public void testFindExistingUsersByMetadataId() {
        List<UUID> idsToFind = Arrays.asList(entity1.getMetadataId(), entity2.getMetadataId());
        
        List<SpsCirrusContactMetadata> results = repository.findExistingUsersByMetadataId(idsToFind);
        
        Assertions.assertEquals(2, results.size());
        Assertions.assertTrue(results.stream().anyMatch(e -> e.getUserAccountGuid().equals(userGuid1)));
        Assertions.assertTrue(results.stream().anyMatch(e -> e.getUserAccountGuid().equals(userGuid2)));
    }

    @Test
    public void testFindByUserAccountGuidAndPersonaId() {
        List<SpsCirrusContactMetadata> results = repository.findByUserAccountGuidAndPersonaId(userGuid1, personaId1);
        
        Assertions.assertNotNull(results);
        Assertions.assertFalse(results.isEmpty());
        Assertions.assertEquals(entity1.getMetadataId(), results.get(0).getMetadataId());
    }

    @Test
    public void testFindLatestHashByUserAccountGuid() {
        // Note: This test relies on the Native Query in the repository. 
        // Ensure H2/Test DB has schema 'sp_schema' or the query is adjusted for test profiles.
        
        UUID specificUser = UUID.randomUUID();
        
        // Old Record
        SpsCirrusContactMetadata oldRecord = new SpsCirrusContactMetadata();
        oldRecord.setUserAccountGuid(specificUser);
        oldRecord.setHashValue(100);
        oldRecord.setUpdatedDate(new Date(System.currentTimeMillis() - 10000)); // 10 seconds ago
        repository.save(oldRecord);

        // New Record
        SpsCirrusContactMetadata newRecord = new SpsCirrusContactMetadata();
        newRecord.setUserAccountGuid(specificUser);
        newRecord.setHashValue(200);
        newRecord.setUpdatedDate(new Date()); // Now
        repository.save(newRecord);
        
        entityManager.flush();

        Integer latestHash = repository.findLatestHashByUserAccountGuid(specificUser);
        
        Assertions.assertNotNull(latestHash);
        Assertions.assertEquals(200, latestHash, "Should return the hash from the most recently updated record");
    }

    @Test
    public void testSetStatus() {
        // Verify initial status
        Assertions.assertEquals(RegistrationStatus.PENDING, entity1.getRegistrationStatus());

        int rowsUpdated = repository.setStatus(userGuid1, personaId1, RegistrationStatus.FAILED);
        
        Assertions.assertEquals(1, rowsUpdated);

        // Because setStatus has @Modifying(clearAutomatically = true), the context is refreshed.
        // We retrieve the entity again to verify the update.
        SpsCirrusContactMetadata updatedEntity = repository.findByMetadataId(entity1.getMetadataId());
        Assertions.assertEquals(RegistrationStatus.FAILED, updatedEntity.getRegistrationStatus());
    }

    @Test
    public void testIncrementRetry() {
        int initialRetry = entity1.getRetryCount(); // Should be 0
        
        int rowsUpdated = repository.incrementRetry(entity1.getMetadataId());
        Assertions.assertEquals(1, rowsUpdated);

        // IMPORTANT: incrementRetry does NOT have clearAutomatically = true in the repo interface.
        // We must manually clear the EntityManager, otherwise a findById will return the 
        // cached entity (with retry=0) instead of fetching the incremented value from DB.
        entityManager.clear();

        SpsCirrusContactMetadata updatedEntity = repository.findByMetadataId(entity1.getMetadataId());
        Assertions.assertEquals(initialRetry + 1, updatedEntity.getRetryCount());
    }

    @Test
    public void testFindAllByRegistrationStatus() {
        List<SpsCirrusContactMetadata> completed = repository.findAllByRegistrationStatus(RegistrationStatus.COMPLETED);
        
        Assertions.assertFalse(completed.isEmpty());
        Assertions.assertEquals(entity2.getMetadataId(), completed.get(0).getMetadataId());
    }

    private void createExtraEntity(RegistrationStatus status) {
        SpsCirrusContactMetadata e = new SpsCirrusContactMetadata();
        e.setUserAccountGuid(UUID.randomUUID());
        e.setRegistrationStatus(status);
        repository.save(e);
    }
}
