package com.personalcapital.cache.aop;

import io.micrometer.core.instrument.Metrics;
import io.micrometer.core.instrument.simple.SimpleMeterRegistry;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.Signature;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

public class PcapMultiCacheableAdviceTest {
    
    private PcapMultiCacheableAdvice cacheAdvice;
    private SimpleMeterRegistry meterRegistry;
    
    private static final String METRICS_NAME = "pcap.cache.event";
    
    @BeforeEach
    void setUp() {
        meterRegistry = new SimpleMeterRegistry();
        Metrics.addRegistry(meterRegistry);
        cacheAdvice = new PcapMultiCacheableAdvice();
    }

    @Test
    void testCacheMissMetric() {
        // Mock JoinPoint
        ProceedingJoinPoint pjp = mock(ProceedingJoinPoint.class);
        Signature mockSignature = mock(Signature.class);

        when(pjp.getTarget()).thenReturn(this);
        when(pjp.getSignature()).thenReturn(mockSignature);
        when(mockSignature.getName()).thenReturn("testMethod");

        cacheAdvice.recordCaching(pjp, "miss");

        assertEquals(1, meterRegistry.get(METRICS_NAME)
                .tag("class", this.getClass().getSimpleName())
                .tag("method", "testMethod")
                .tag("outcome", "miss")
                .counter().count());

        System.out.println("Cache Miss Metric Count: " +
                meterRegistry.get(METRICS_NAME).tag("outcome", "miss").counter().count());
    }
}

package com.personalcapital.cache.aop;

import io.micrometer.core.instrument.Metrics;
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.simple.SimpleMeterRegistry;
import org.aspectj.lang.ProceedingJoinPoint;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.MockedStatic;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

public class PcapMultiCacheableAdviceTest {
    private PcapMultiCacheableAdvice cacheAdvice;
    private SimpleMeterRegistry meterRegistry;

    @BeforeEach
    void setUp() {
        meterRegistry = new SimpleMeterRegistry();
        Metrics.addRegistry(meterRegistry);
        cacheAdvice = new PcapMultiCacheableAdvice();
    }

    @Test
    void testRecordCachingMetric() {
        ProceedingJoinPoint pjp = mock(ProceedingJoinPoint.class);
        when(pjp.getTarget()).thenReturn(this);
        when(pjp.getSignature().getName()).thenReturn("testMethod");

        try (MockedStatic<Metrics> mockedMetrics = mockStatic(Metrics.class)) {
            Counter mockCounter = mock(Counter.class);
            mockedMetrics.when(() -> Metrics.counter(anyString(), anyVararg())).thenReturn(mockCounter);
            cacheAdvice.recordCaching(pjp, "miss");

            ArgumentCaptor<String> metricNameCaptor = ArgumentCaptor.forClass(String.class);
            ArgumentCaptor<String> tagKeyCaptor = ArgumentCaptor.forClass(String.class);
            ArgumentCaptor<String> tagValueCaptor = ArgumentCaptor.forClass(String.class);

            mockedMetrics.verify(() -> Metrics.counter(metricNameCaptor.capture(), anyVararg()));
            assertEquals("pcap.cache.event", metricNameCaptor.getValue());
            verify(mockCounter, times(1)).increment();

            System.out.println("Metric Captured Successfully: " + metricNameCaptor.getValue());
        }
    }
}
