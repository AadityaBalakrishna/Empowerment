package com.empower.epw.aws.service.config;

import com.amazonaws.services.kms.AWSKMS;
import com.empower.epw.aws.api.kms.EpwKmsService;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.test.context.TestPropertySource;
import software.amazon.awssdk.services.kms.KmsClient;

import static org.junit.jupiter.api.Assertions.assertSame;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.mock;

class EpwAwsKmsAutoConfigIT {

    @SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
    static class TestApplication {
    }

    /**
     * SCENARIO 1: No consumer bean and no property. The system should fall back to the default v1 adapter.
     */
    @Nested
    @SpringBootTest(classes = TestApplication.class)
    class DefaultV1FallbackTest {

        @Autowired
        private EpwKmsService kmsService;

        @Test
        void shouldUseV1Implementation() {
            assertTrue(kmsService instanceof com.empower.epw.sdk.v1.adapter.kms.EpwKmsServiceImpl);
        }
    }

    /**
     * SCENARIO 2: Property is set to 'v2'. The v2 adapter should be loaded.
     */
    @Nested
    @SpringBootTest(classes = TestApplication.class)
    @TestPropertySource(properties = "epw.aws.kms.sdk.version=v2")
    class V2PropertySetTest {

        @Autowired
        private EpwKmsService kmsService;

        @Test
        void shouldUseV2Implementation() {
            assertTrue(kmsService instanceof com.empower.epw.sdk.v2.adapter.kms.EpwKmsServiceImpl);
        }
    }

    /**
     * SCENARIO 3: A consumer provides their own custom AWSKMS bean. Our library should use it in the v1 service.
     */
    @Nested
    @SpringBootTest(classes = {TestApplication.class, ConsumerProvidesClientTest.CustomClientConfig.class})
    @TestPropertySource(properties = "epw.aws.kms.sdk.version=v1")
    class ConsumerProvidesClientTest {

        @TestConfiguration
        static class CustomClientConfig {
            @Bean
            public AWSKMS customAwsKmsClient() {
                return mock(AWSKMS.class, "consumerCustomKmsClient");
            }
        }

        @Autowired
        private AWSKMS injectedClient;

        @Autowired
        private com.empower.epw.sdk.v1.adapter.kms.EpwKmsServiceImpl serviceImpl;

        @Test
        @Disabled("Enable after adding a public getter in EpwKmsServiceImpl for the AWSKMS client")
        void serviceShouldUseTheConsumerProvidedClient() {
            // Add a getAwsKmsClient() method in v1 EpwKmsServiceImpl to run this test
            // assertSame(injectedClient, serviceImpl.getAwsKmsClient());
        }
    }
}
