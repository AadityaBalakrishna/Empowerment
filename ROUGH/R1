pipeline {
  agent any
  stages {
    stage('Test IAM Role') {
      steps {
        sh '''
          echo "Assuming devtrunk test role..."
          aws sts assume-role \
            --role-arn arn:aws:iam::<account-id>:role/devtrunk-common-test-role \
            --role-session-name jenkins-test \
            --query 'Credentials' \
            --output json > creds.json

          export AWS_ACCESS_KEY_ID=$(jq -r '.AccessKeyId' creds.json)
          export AWS_SECRET_ACCESS_KEY=$(jq -r '.SecretAccessKey' creds.json)
          export AWS_SESSION_TOKEN=$(jq -r '.SessionToken' creds.json)

          echo "Testing role permissions..."
          aws s3 ls
        '''
      }
    }
  }
}
