package com.personalcapital.salesforce.sps;

import com.personalcapital.salesforce.sps.entity.SpsCirrusContactMetadata;
import com.personalcapital.salesforce.sps.enums.RegistrationStatus;
import com.personalcapital.salesforce.sps.enums.UserSpsPlanType;
import com.personalcapital.salesforce.sps.repository.SpsCirrusContactMetadataRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.annotation.Rollback;
import org.springframework.test.context.junit.jupiter.SpringJUnitConfig;
import org.springframework.transaction.annotation.Transactional;

import java.util.Collections;
import java.util.List;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

@Rollback
@Transactional(value = "spTran")
@SpringJUnitConfig(locations = "classpath:persistenceApplicationContext.xml")
class SpsCirrusContactMetadataRepositoryTest {

    @Autowired
    private SpsCirrusContactMetadataRepository repository;

    private UUID testMetadataId;
    private UUID testUserAccountGuid;
    private UUID testPersonaId;

    @BeforeEach
    void setUp() {
        repository.deleteAll();

        testMetadataId = UUID.randomUUID();
        testUserAccountGuid = UUID.randomUUID();
        testPersonaId = UUID.randomUUID();

        SpsCirrusContactMetadata entity = new SpsCirrusContactMetadata(
                testMetadataId,
                testUserAccountGuid,
                testPersonaId,
                UserSpsPlanType.CONFORMING,
                RegistrationStatus.PENDING);
        
        entity.setRetryCount(0);

        repository.save(entity);
    }

    @Test
    void findByMetadataId_returnsEntity() {
        SpsCirrusContactMetadata result = repository.findByMetadataId(testMetadataId);

        assertNotNull(result);
        assertEquals(testMetadataId, result.getMetadataId());
        assertEquals(testUserAccountGuid, result.getUserAccountGuid());
    }

    @Test
    void setStatus_returnsUpdatedCount() {
        int updatedCount = repository.setStatus(
                testUserAccountGuid,
                testPersonaId,
                RegistrationStatus.COMPLETED);

        assertEquals(1, updatedCount);

        SpsCirrusContactMetadata updatedEntity = repository.findByMetadataId(testMetadataId);
        assertNotNull(updatedEntity);
        assertEquals(RegistrationStatus.COMPLETED, updatedEntity.getRegistrationStatus());
    }

    @Test
    void incrementRetry_returnsUpdatedCount() {
        int updatedCount = repository.incrementRetry(testMetadataId);

        assertEquals(1, updatedCount);

        SpsCirrusContactMetadata updatedEntity = repository.findByMetadataId(testMetadataId);
        assertNotNull(updatedEntity);
        assertEquals(1, updatedEntity.getRetryCount());
    }

    @Test
    void findExistingUsersByMetadataId_returnsEntity() {
        List<SpsCirrusContactMetadata> results = repository.findExistingUsersByMetadataId(
                Collections.singletonList(testMetadataId));

        assertNotNull(results);
        assertEquals(1, results.size());
        assertEquals(testMetadataId, results.get(0).getMetadataId());
    }

    @Test
    void findByUserAccountGuidAndPersonaId_returnsEntity() {
        List<SpsCirrusContactMetadata> results = repository.findByUserAccountGuidAndPersonaId(
                testUserAccountGuid,
                testPersonaId);

        assertNotNull(results);
        assertEquals(1, results.size());
        assertEquals(testMetadataId, results.get(0).getMetadataId());
    }

    @Test
    void findLatestHashByUserAccountGuid_returnsHash() {
        Integer hash = repository.findLatestHashByUserAccountGuid(testUserAccountGuid);
        assertNull(hash);
    }

    @Test
    void findAllByRegistrationStatus_returnsList() {
        List<SpsCirrusContactMetadata> results = repository.findAllByRegistrationStatus(
                RegistrationStatus.PENDING);

        assertNotNull(results);
        assertEquals(1, results.size());
        assertEquals(RegistrationStatus.PENDING, results.get(0).getRegistrationStatus());
    }
}
