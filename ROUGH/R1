package com.empower.epw.crm.gateway.sqs;

import java.net.SocketTimeoutException;

import org.springframework.stereotype.Service;

import com.empower.epw.crm.gateway.sqs.utils.NonRetryableException;
import com.empower.epw.crm.gateway.sqs.utils.RetryableException;
import lombok.CustomLog;

@CustomLog
@Service
public class CrmProcessingService
{

	public void processMessage(String type, String message, String messageId)
	{
		log.info("Received from [{}] queue type, message [ID: {}]: {}", type,
				messageId != null ? messageId : "NA", message);

		// TODO - Update the Error Handling as per business requirements
		try{
			// Use this template to categorize the errors and determine which needs to be sent to DLQ
			
			//Use case 1: un-processable message
			if(message != null && message.trim().contains("FAIL_MESSAGE")){
				log.warn("FAIL_MESSAGE detected, will be logged");
				throw new NonRetryableException("Designated failure message: "+ message);
			}
			
			//Use case 2: Transient errors like DB/network timeout
			if(message != null && message.trim().contains("TRANSIENT_ERROR")){
				log.warn("FAIL_MESSAGE detected, will be logged");
				var transientError = new SocketTimeoutException("Simulated DB timeout");
				throw new RetryableException(transientError);
			}
			
			//Use case 3: code bug
			if(message != null && message.trim().contains("CODE_BUG")){
				throw new NullPointerException("Simulating Code failure");
			}
			
			log.info("Message from queue type [{}] processed successfully.", type);
		} catch (RetryableException re){
			// Re-throw the RETRYABLE signal to be caught by the errorHandler
			throw re;
			
		} catch (NonRetryableException nre){
			// Re-throw the NON_RETRYABLE signal to be caught by the errorHandler
			throw nre;
			
		} catch (Exception ex){
			// Catch all other exceptions and wrap them as NON_RETRYABLE
			log.error("An unexcepted error occurred.", ex);
			throw new NonRetryableException("Unexpected processing error", ex);
		}
	}
}

i have updated the processing service like this, check and save
