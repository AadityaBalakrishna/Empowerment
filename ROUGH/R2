package com.personalcapital.salesforce.sps.repository;

import com.personalcapital.salesforce.sps.enums.RegistrationStatus;
import com.personalcapital.salesforce.sps.entity.SpsCirrusContactMetadata;

import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.Collection;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Repository
public interface SpsCirrusContactMetadataRepository
		extends JpaRepository<SpsCirrusContactMetadata, UUID>
{
	@Transactional(readOnly = true)
	Optional<SpsCirrusContactMetadata> findByMetadataId(UUID metadataId);

	@Transactional(readOnly = true)
	Slice<SpsCirrusContactMetadata> findByRegistrationStatus(
            RegistrationStatus registrationStatus, Pageable pageable);

	@Transactional(readOnly = true)
	@Query("select m from SpsCirrusContactMetadata m where m.metadataId in :metadataIds")
	List<SpsCirrusContactMetadata> findExistingUsersByMetadataId(@Param("metadataIds") Collection<UUID> metadataIds);

	@Transactional(readOnly = true)
	List<SpsCirrusContactMetadata> findByUserAccountGuidAndPersonaId(UUID userAccountGuid, UUID personaId);

	@Transactional(readOnly = true)
	Optional<SpsCirrusContactMetadata> findTopByUserAccountGuidOrderByUpdatedDateDescMetadataIdDesc(UUID userAccountGuid);

	default Optional<Integer> findLatestHashByUserAccountGuid(UUID userAccountGuid) {
		return findTopByUserAccountGuidOrderByUpdatedDateDescMetadataIdDesc(userAccountGuid)
				.map(SpsCirrusContactMetadata::getHashValue);
	}

	@Modifying(clearAutomatically = true, flushAutomatically = true)
	@Transactional
	@Query("update SpsCirrusContactMetadata m set m.registrationStatus = :status " + "where m.userAccountGuid = :userAccountGuid and m.personaId = :personaId")
	int setStatus(@Param("userAccountGuid") UUID userAccountGuid, @Param("personaId") UUID personaId,
                  @Param("status") RegistrationStatus registrationStatus);

	@Modifying
	@Transactional
	@Query("update SpsCirrusContactMetadata m set m.retryCount = m.retryCount + 1 where m.metadataId = :metadataId")
	int incrementRetry(@Param("metadataId") UUID metadataId);

	// getEntriesByStatus(registrationStatus)
	@Transactional(readOnly = true)
	List<SpsCirrusContactMetadata> findAllByRegistrationStatus(RegistrationStatus status);
}


need to address two review comments:
1) see whether this creates findById() automatically , that might create error for developer using it, then entity might need.
@AttributeOverride(name="id", column=@Column(name="metadata_id"))

for this:
	@Transactional(readOnly = true)
	Optional<SpsCirrusContactMetadata> findByMetadataId(UUID metadataId);

suggestion:
"we could use default method like: 
 
default Optional<SpsCirrusContactMetadata> findByMetadataId(UUID metadataId) {
    return findById(metadataId);
}

OR
 
A wrapper utility class : ContactMetadataService
which will have
 
public Optional<SpsCirrusContactMetadata> findByMetadataId(UUID metadataId) {
        return repository.findById(metadataId);
    }"

another review comment for the same - "orif u want a more convenient wrapper use findByMetadataId(id) { findById(id); }"
