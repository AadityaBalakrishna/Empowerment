package com.empower.epw.crm.gateway.sqs;

import io.awspring.cloud.sqs.annotation.SqsListener;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Retryable;
import org.springframework.stereotype.Component;
import com.personalcapital.log.PcapLogger;
import com.personalcapital.log.PcapLoggerFactory;

@Component
public class CrmGatewayMessageListener {

    private static final PcapLogger logger = PcapLoggerFactory.getPcapLogger(CrmGatewayMessageListener.class);

    @SqsListener("${crm.gateway.sqs.queue.dryrun:}")
    @Retryable(
            value = { Exception.class },
            maxAttemptsExpression = "#{${crm-gateway.sqs.retry.max-attempts:3}}",
            backoff = @Backoff(delayExpression = "#{${crm-gateway.sqs.retry.backoff-delay:1000}}")
    )
    public void handleDryRunMessage(String message) {
        processMessage("DRY_RUN", message);
    }

    @SqsListener("${crm.gateway.sqs.queue.intermediate:}")
    @Retryable(
            value = { Exception.class },
            maxAttemptsExpression = "#{${crm-gateway.sqs.retry.max-attempts:3}}",
            backoff = @Backoff(delayExpression = "#{${crm-gateway.sqs.retry.backoff-delay:1000}}")
    )
    public void handleIntermediateMessage(String message) {
        processMessage("INTERMEDIATE", message);
    }

    @SqsListener("${crm.gateway.sqs.queue.normal:}")
    @Retryable(
            value = { Exception.class },
            maxAttemptsExpression = "#{${crm-gateway.sqs.retry.max-attempts:3}}",
            backoff = @Backoff(delayExpression = "#{${crm-gateway.sqs.retry.backoff-delay:1000}}")
    )
    public void handleNormalMessage(String message) {
        processMessage("NORMAL", message);
    }

    @SqsListener("${crm.gateway.sqs.queue.top:}")
    @Retryable(
            value = { Exception.class },
            maxAttemptsExpression = "#{${crm-gateway.sqs.retry.max-attempts:3}}",
            backoff = @Backoff(delayExpression = "#{${crm-gateway.sqs.retry.backoff-delay:1000}}")
    )
    public void handleTopMessage(String message) {
        processMessage("TOP", message);
    }

    private void processMessage(String type, String message) {
        logger.info("Received [{}] message: {}", type, message);

        try {
            // TODO: handle domain logic here
            logger.info("Message [{}] processed successfully.", type);
        } catch (Exception ex) {
            logger.error("Error processing [{}] message: {}", type, ex.getMessage(), ex);
            throw ex; // triggers @Retryable
        }
    }
}

i have this listner class, but i need to test it with a local stack IT test which is able to create it's own queues and test this listener:
#CRM Gateway SQS Queues
StageMap.capName=DEVTRUNK
crm.gateway.sqs.queue.dryrun=${StageMap.capName}_CRM_GATEWAY_DRY_RUN
crm.gateway.sqs.queue.intermediate=${StageMap.capName}_CRM_GATEWAY_INTERMEDIATE
crm.gateway.sqs.queue.normal=DEV_CRM_GATEWAY_NORMAL
crm.gateway.sqs.queue.top=${StageMap.capName}_CRM_GATEWAY_TOP

